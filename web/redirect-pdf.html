<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redireccionando a PDF...</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f8f9fa;
            text-align: center;
        }
        
        .loading {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pdf-list {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: left;
        }
        
        .pdf-link {
            display: block;
            background: #e74c3c;
            color: white;
            padding: 1rem;
            margin: 0.5rem 0;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .pdf-link:hover {
            background: #c0392b;
        }
        
        .back-link {
            display: inline-block;
            background: #95a5a6;
            color: white;
            padding: 0.8rem 1.5rem;
            text-decoration: none;
            border-radius: 4px;
            margin-top: 1rem;
        }
        
        .back-link:hover {
            background: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <h2>üîç Buscando PDFs...</h2>
        <p>Detectando documentos en esta carpeta...</p>
    </div>
    
    <div class="pdf-list" id="pdf-list" style="display: none;">
        <h2>üìÑ Documentos encontrados:</h2>
        <div id="pdf-links"></div>
        <a href="javascript:history.back()" class="back-link">‚Üê Volver a la biblioteca</a>
    </div>
    
    <div class="pdf-list" id="no-pdfs" style="display: none;">
        <h2>üìÅ Sin documentos PDF</h2>
        <p>Esta carpeta no contiene archivos PDF.</p>
        <a href="/" class="back-link">üè† Volver a la biblioteca</a>
        <a href="javascript:history.back()" class="back-link">‚Üê Volver atr√°s</a>
    </div>

    <script>
        class PDFRedirect {
            constructor() {
                this.currentUrl = window.location.href;
                this.pathSegments = window.location.pathname.split('/').filter(Boolean);
                this.detectAndRedirect();
            }
            
            async detectAndRedirect() {
                try {
                    // Si ya estamos en un PDF, no hacer nada
                    if (this.currentUrl.endsWith('.pdf')) {
                        return;
                    }
                    
                    // Si estamos en un directorio de storage, buscar PDFs
                    if (this.pathSegments.includes('storage')) {
                        await this.findPDFsInDirectory();
                    } else {
                        this.showNoPDFs();
                    }
                } catch (error) {
                    console.error('Error en detecci√≥n de PDFs:', error);
                    this.showNoPDFs();
                }
            }
            
            async findPDFsInDirectory() {
                try {
                    const response = await fetch(window.location.href);
                    if (!response.ok) throw new Error('No se pudo cargar el directorio');
                    
                    const html = await response.text();
                    const pdfLinks = this.extractPDFLinks(html);
                    
                    if (pdfLinks.length === 1) {
                        // Solo un PDF, redirigir autom√°ticamente
                        console.log('üìÑ Redirigiendo autom√°ticamente a:', pdfLinks[0].url);
                        window.location.href = pdfLinks[0].url;
                    } else if (pdfLinks.length > 1) {
                        // M√∫ltiples PDFs, mostrar lista
                        this.showPDFList(pdfLinks);
                    } else {
                        // No hay PDFs
                        this.showNoPDFs();
                    }
                } catch (error) {
                    console.error('Error buscando PDFs:', error);
                    this.showNoPDFs();
                }
            }
            
            extractPDFLinks(html) {
                const links = [];
                const regex = /href="([^"]*\.pdf)"/gi;
                let match;
                
                while ((match = regex.exec(html)) !== null) {
                    const href = match[1];
                    const fileName = href.split('/').pop() || href;
                    const cleanName = decodeURIComponent(fileName);
                    
                    // Construir URL completa
                    const fullUrl = new URL(href, window.location.href).href;
                    
                    links.push({
                        url: fullUrl,
                        name: cleanName,
                        originalHref: href
                    });
                }
                
                return links;
            }
            
            showPDFList(pdfLinks) {
                const loading = document.getElementById('loading');
                const pdfList = document.getElementById('pdf-list');
                const linksContainer = document.getElementById('pdf-links');
                
                loading.style.display = 'none';
                pdfList.style.display = 'block';
                
                pdfLinks.forEach(pdf => {
                    const link = document.createElement('a');
                    link.href = pdf.url;
                    link.className = 'pdf-link';
                    link.target = '_blank';
                    link.textContent = `üìÑ ${pdf.name}`;
                    linksContainer.appendChild(link);
                });
                
                console.log(`üìÑ Encontrados ${pdfLinks.length} PDFs:`, pdfLinks);
            }
            
            showNoPDFs() {
                const loading = document.getElementById('loading');
                const noPdfs = document.getElementById('no-pdfs');
                
                loading.style.display = 'none';
                noPdfs.style.display = 'block';
            }
        }
        
        // Iniciar cuando se cargue la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            new PDFRedirect();
        });
        
        // Timeout de seguridad - si no se encuentra nada en 5 segundos, mostrar opciones
        setTimeout(() => {
            if (document.getElementById('loading').style.display !== 'none') {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('no-pdfs').style.display = 'block';
            }
        }, 5000);
    </script>
</body>
</html>