<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca Zotero</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .search-box {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .item {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .item-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }
        
        .item-authors {
            color: #7f8c8d;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .item-year {
            color: #3498db;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .item-meta {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .item-type {
            color: #9b59b6;
            font-size: 0.8rem;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
            font-weight: 500;
        }
        
        .attachments {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .other-attachments {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-top: 0.5rem;
        }
        
        .attachment-link {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            background: #ecf0f1;
            color: #34495e;
            text-decoration: none;
            border-radius: 3px;
            font-size: 0.8rem;
            transition: background-color 0.3s;
        }
        
        .attachment-link:hover {
            background: #d5dbdb;
        }
        
        .stats-section {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .stats-section h2 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #3498db;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .chart-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .chart-card h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .chart-content {
            min-height: 200px;
        }
        
        .chart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .chart-item:last-child {
            border-bottom: none;
        }
        
        .chart-label {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .chart-value {
            background: #3498db;
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .chart-bar {
            background: #e9ecef;
            height: 20px;
            border-radius: 10px;
            margin-top: 0.3rem;
            overflow: hidden;
        }
        
        .chart-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            transition: width 0.8s ease;
        }
        
        .explore-link {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: #f39c12;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
            margin-right: 0.5rem;
        }
        
        .explore-link:hover {
            background: #d68910;
        }
        
        .show-direct-btn {
            padding: 0.3rem 0.8rem;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .show-direct-btn:hover {
            background: #7f8c8d;
        }
        
        .direct-links input {
            margin-top: 0.2rem;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .direct-links input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        /* Estad√≠sticas compactas en header */
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .compact-stats {
            display: flex;
            gap: 1rem;
        }
        
        .stat-mini {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            background: rgba(255,255,255,0.1);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .stat-icon {
            font-size: 1rem;
        }
        
        /* Pesta√±as de b√∫squeda */
        .search-tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .search-tab {
            padding: 0.8rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            color: #7f8c8d;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
        }
        
        .search-tab:hover {
            color: #2c3e50;
            background: #f8f9fa;
        }
        
        .search-tab.active {
            color: #2c3e50;
            border-bottom-color: #3498db;
            font-weight: 600;
        }
        
        .search-tab-content {
            display: none;
        }
        
        .search-tab-content.active {
            display: block;
        }
        
        /* √Årbol de carpetas */
        .folder-tree-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .folder-tree-header {
            padding: 1rem;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }
        
        .close-tree-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .folder-tree {
            padding: 1rem;
        }
        
        .folder-item {
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.3s;
            user-select: none;
        }
        
        .folder-item:hover {
            background: #f8f9fa;
        }
        
        .folder-item.expanded {
            background: #e3f2fd;
        }
        
        .folder-toggle {
            display: inline-block;
            width: 20px;
            cursor: pointer;
            color: #3498db;
        }
        
        .folder-name {
            margin-left: 0.5rem;
            font-weight: 500;
        }
        
        .folder-stats {
            margin-left: 0.5rem;
            font-size: 0.8rem;
            color: #7f8c8d;
        }
        
        .folder-children {
            margin-left: 1.5rem;
            display: none;
        }
        
        .folder-children.expanded {
            display: block;
        }
        
        /* Resultados de b√∫squeda */
        .folder-results, .text-results {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 2rem;
        }
        
        .result-item {
            padding: 1rem;
            border-bottom: 1px solid #ecf0f1;
            transition: background-color 0.3s;
        }
        
        .result-item:hover {
            background: #f8f9fa;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .result-path {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 0.5rem;
        }
        
        .result-context {
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
            font-family: monospace;
            margin-top: 0.5rem;
        }
        
        .result-meta {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: #7f8c8d;
        }
        
        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .compact-stats {
                justify-content: center;
            }
            
            .search-tabs {
                flex-wrap: wrap;
            }
            
            .search-tab {
                flex: 1;
                min-width: 120px;
            }
        }
        
        .pdf-link {
            display: inline-block;
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background: #e74c3c;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .pdf-link:hover {
            background: #c0392b;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }
        
        .error {
            background: #e74c3c;
            color: white;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>üìö Biblioteca Zotero</h1>
            <p>Accede a tu biblioteca personal de documentos</p>
            <div class="nav" style="margin-top: 1rem;">
                <a href="index.html" style="color: #ecf0f1; text-decoration: none; margin-right: 2rem; padding: 0.5rem 1rem; border-radius: 4px; background: rgba(255,255,255,0.2);">üè† Biblioteca Zotero</a>
                <a href="storage.html" style="color: #ecf0f1; text-decoration: none; margin-right: 2rem; padding: 0.5rem 1rem; border-radius: 4px; transition: background-color 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">üìÅ Explorar Storage</a>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="search-box">
            <div class="search-tabs">
                <button class="search-tab active" data-tab="elements">üìã Elementos</button>
                <button class="search-tab" data-tab="folders">üìÅ Carpetas</button>
                <button class="search-tab" data-tab="text">üîç Texto en PDFs</button>
            </div>
            
            <div class="search-content">
                <div class="search-tab-content active" data-content="elements">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <input type="text" class="search-input" placeholder="Buscar elementos de Zotero..." id="searchInput" style="flex: 1;">
                        <button id="forceUpdateBtn" onclick="window.zoteroLibrary.forceUpdate()" style="padding: 12px 20px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s;">
                            üîÑ Actualizar
                        </button>
                    </div>
                    <div id="syncStatus" style="font-size: 0.9rem; color: #7f8c8d;">
                        üîÑ Conectando sincronizaci√≥n...
                    </div>
                </div>
                
                <div class="search-tab-content" data-content="folders">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <input type="text" class="search-input" placeholder="Buscar carpetas y archivos..." id="searchFolders" style="flex: 1;">
                        <button onclick="window.zoteroLibrary.toggleFolderTree()" style="padding: 12px 20px; background: #e67e22; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üìÇ √Årbol
                        </button>
                    </div>
                </div>
                
                <div class="search-tab-content" data-content="text">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <input type="text" class="search-input" placeholder="Buscar texto dentro de PDFs..." id="searchText" style="flex: 1;">
                        <button onclick="window.zoteroLibrary.searchPDFText()" style="padding: 12px 20px; background: #9b59b6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üîç Buscar
                        </button>
                    </div>
                    <div style="font-size: 0.8rem; color: #7f8c8d; margin-top: 0.5rem;">
                        B√∫squeda con OCR autom√°tico en segundo plano
                    </div>
                </div>
            </div>
        </div>
        
        <div id="error-message" class="error" style="display: none;"></div>
        <div id="loading" class="loading">Cargando biblioteca...</div>
        
        <!-- √Årbol de carpetas desplegable -->
        <div id="folder-tree-container" class="folder-tree-container" style="display: none;">
            <div class="folder-tree-header">
                <h3>üìÇ Estructura de Carpetas</h3>
                <button onclick="window.zoteroLibrary.toggleFolderTree()" class="close-tree-btn">‚úï</button>
            </div>
            <div id="folder-tree" class="folder-tree"></div>
        </div>
        
        <!-- Contenido principal que cambia seg√∫n la pesta√±a activa -->
        <div id="main-content">
            <div id="library-grid" class="library-grid" style="display: none;"></div>
            <div id="folder-results" class="folder-results" style="display: none;"></div>
            <div id="text-results" class="text-results" style="display: none;"></div>
        </div>
    </div>

    <script>
        class ZoteroLibrary {
            constructor() {
                this.searchInput = document.getElementById('searchInput');
                this.libraryGrid = document.getElementById('library-grid');
                this.loading = document.getElementById('loading');
                this.errorMessage = document.getElementById('error-message');
                
                this.init();
            }
            
            async init() {
                try {
                    await this.loadStatistics();
                    await this.loadLibrary();
                    this.setupSearch();
                } catch (error) {
                    this.showError('Error al cargar la biblioteca: ' + error.message);
                }
            }
            
            async loadStatistics() {
                try {
                    let response = await fetch('/api/library-stats');
                    if (!response.ok) {
                        response = await fetch('http://localhost:3000/library-stats');
                    }
                    
                    if (response.ok) {
                        const stats = await response.json();
                        this.displayStatistics(stats);
                        
                        const statsSection = document.getElementById('stats-section');
                        statsSection.style.display = 'block';
                    }
                } catch (error) {
                    console.log('No se pudieron cargar estad√≠sticas:', error.message);
                    // No mostrar error, las estad√≠sticas son opcionales
                }
            }
            
            displayStatistics(stats) {
                // Estad√≠sticas principales
                document.getElementById('total-pdfs').textContent = stats.totals.allPdfs.toLocaleString();
                document.getElementById('total-folders').textContent = stats.storage.totalFolders.toLocaleString();
                document.getElementById('biblioteca-pdfs').textContent = stats.biblioteca.pdfFiles.toLocaleString();
                
                // Tama√±o estimado
                const sizeInMB = Math.round(stats.biblioteca.totalSize / 1024 / 1024);
                document.getElementById('total-size').textContent = sizeInMB > 1024 ? 
                    `${Math.round(sizeInMB / 1024)} GB` : `${sizeInMB} MB`;
                
                // Gr√°fico de tipos
                this.createChart('item-types-chart', stats.itemTypes, '#e74c3c');
                
                // Gr√°fico de a√±os
                this.createChart('years-chart', stats.yearDistribution, '#3498db');
            }
            
            createChart(containerId, data, color) {
                const container = document.getElementById(containerId);
                if (!data || Object.keys(data).length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 2rem;">No hay datos disponibles</p>';
                    return;
                }
                
                const total = Object.values(data).reduce((sum, val) => sum + val, 0);
                const sortedData = Object.entries(data)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 8); // Top 8
                
                container.innerHTML = '';
                
                sortedData.forEach(([label, value]) => {
                    const percentage = Math.round((value / total) * 100);
                    
                    const item = document.createElement('div');
                    item.className = 'chart-item';
                    
                    item.innerHTML = `
                        <div>
                            <div class="chart-label">${label}</div>
                            <div class="chart-bar">
                                <div class="chart-bar-fill" style="width: 0%; background: ${color}"></div>
                            </div>
                        </div>
                        <div class="chart-value">${value}</div>
                    `;
                    
                    container.appendChild(item);
                    
                    // Animar la barra
                    setTimeout(() => {
                        const bar = item.querySelector('.chart-bar-fill');
                        bar.style.width = percentage + '%';
                    }, 100);
                });
            }
            
            async loadLibrary() {
                try {
                    // Intentar primero con la URL relativa (para proxy)
                    let response = await fetch('/api/library');
                    if (!response.ok) {
                        // Fallback a localhost directo
                        response = await fetch('http://localhost:3000/library');
                    }
                    
                    if (!response.ok) throw new Error('Error de servidor');
                    
                    const items = await response.json();
                    console.log(`üìö Cargados ${items.length} elementos de la biblioteca`);
                    
                    this.items = items;
                    this.filteredItems = [...items];
                    
                    // Si no hay attachments, intentar cargar desde storage directo
                    const enrichedItems = await Promise.all(this.filteredItems.map(item => this.enrichItemWithDirectFiles(item)));
                    
                    this.displayItems(enrichedItems);
                    
                    this.loading.style.display = 'none';
                    this.libraryGrid.style.display = 'grid';
                } catch (error) {
                    console.error('Error cargando biblioteca:', error);
                    this.showError(`Error conectando con la API de Zotero: ${error.message}`);
                }
            }
            
            async enrichItemWithDirectFiles(item) {
                // Si ya tiene attachments, devolverlo como est√°
                if (item.attachments && item.attachments.length > 0) {
                    return item;
                }
                
                // Si no tiene attachments y viene del modo archivo (source: file-system), 
                // ya deber√≠a tener las rutas correctas
                if (item.source === 'file-system' && item.pdfPath) {
                    return item;
                }
                
                // Para items sin attachments de la base de datos, intentar encontrar PDFs
                // usando el patr√≥n com√∫n de IDs de Zotero
                if (item.id && typeof item.id === 'string' && item.id.length === 8) {
                    try {
                        // Verificar si existe una carpeta con este ID
                        const storageUrl = `/storage/${item.id}/`;
                        const response = await fetch(storageUrl);
                        if (response.ok) {
                            const html = await response.text();
                            // Extraer enlaces de PDFs del HTML del directorio
                            const pdfMatches = html.match(/href="[^"]*\.pdf"/gi);
                            if (pdfMatches && pdfMatches.length > 0) {
                                const pdfHref = pdfMatches[0].replace('href="', '').replace('"', '');
                                item.pdfPath = pdfHref;
                                item.hasDirectPdf = true;
                            }
                        }
                    } catch (e) {
                        // Ignorar errores de red
                    }
                }
                
                return item;
            }
            
            async loadFromStorage() {
                try {
                    const response = await fetch('/storage/');
                    if (response.ok) {
                        const files = await response.json();
                        const items = this.parseStorageFiles(files);
                        this.displayItems(items);
                        
                        this.loading.style.display = 'none';
                        this.libraryGrid.style.display = 'grid';
                    } else {
                        throw new Error('No se puede acceder al storage');
                    }
                } catch (error) {
                    this.showError('No se pudo cargar la biblioteca. Verifica que Zotero est√© configurado correctamente.');
                }
            }
            
            parseStorageFiles(files) {
                // Parsear archivos del directorio de storage de Zotero
                const items = [];
                files.forEach(file => {
                    if (file.name.endsWith('.pdf')) {
                        items.push({
                            title: file.name.replace('.pdf', '').replace(/_/g, ' '),
                            authors: 'Autor desconocido',
                            year: 'Sin fecha',
                            pdfPath: '/storage/' + file.name
                        });
                    }
                });
                return items;
            }
            
            displayItems(items) {
                this.libraryGrid.innerHTML = '';
                
                if (items.length === 0) {
                    this.libraryGrid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #7f8c8d;">No se encontraron elementos en la biblioteca.</p>';
                    return;
                }
                
                items.forEach(item => {
                    const itemElement = this.createItemElement(item);
                    this.libraryGrid.appendChild(itemElement);
                });
            }
            
            createItemElement(item) {
                const div = document.createElement('div');
                div.className = 'item';
                
                // Crear lista de attachments si existen
                let attachmentsHtml = '';
                if (item.attachments && item.attachments.length > 0) {
                    const pdfAttachments = item.attachments.filter(att => att.isPDF);
                    const otherAttachments = item.attachments.filter(att => !att.isPDF);
                    
                    if (pdfAttachments.length > 0) {
                        attachmentsHtml += '<div class="attachments">';
                        pdfAttachments.forEach(att => {
                            // Usar la URL directa del archivo
                            const directUrl = att.fullUrl || att.path;
                            attachmentsHtml += `<a href="${directUrl}" target="_blank" class="pdf-link">üìÑ ${att.fileName}</a>`;
                        });
                        attachmentsHtml += '</div>';
                    }
                    
                    if (otherAttachments.length > 0) {
                        attachmentsHtml += '<div class="other-attachments">';
                        otherAttachments.forEach(att => {
                            const icon = this.getFileIcon(att.fileName);
                            const directUrl = att.fullUrl || att.path;
                            attachmentsHtml += `<a href="${directUrl}" target="_blank" class="attachment-link">${icon} ${att.fileName}</a>`;
                        });
                        attachmentsHtml += '</div>';
                    }
                } else if (item.pdfPath) {
                    // Fallback para items con pdfPath directo
                    attachmentsHtml = `<a href="${item.pdfPath}" target="_blank" class="pdf-link">üìÑ Ver PDF</a>`;
                } else if (item.id && typeof item.id === 'string') {
                    // Para items sin attachments, crear enlaces de exploraci√≥n
                    const exploreUrl = `/storage/${item.id}/`;
                    attachmentsHtml = `
                        <div class="attachments">
                            <a href="${exploreUrl}" target="_blank" class="explore-link">üìÅ Explorar archivos</a>
                            <button onclick="this.parentElement.querySelector('.direct-links').style.display='block'; this.style.display='none'" class="show-direct-btn">üîó Mostrar enlaces directos</button>
                            <div class="direct-links" style="display: none; margin-top: 0.5rem;">
                                <small>Enlaces directos (copia y pega):</small><br>
                                <input type="text" value="https://zotero.neuropedialab.org/storage/${item.id}/" readonly style="width: 100%; font-size: 0.8rem; padding: 0.2rem;">
                            </div>
                        </div>
                    `;
                }
                
                div.innerHTML = `
                    <div class="item-title">${item.title || 'Sin t√≠tulo'}</div>
                    <div class="item-authors">${item.authors || 'Autor desconocido'}</div>
                    <div class="item-meta">
                        <span class="item-year">${item.year || 'Sin fecha'}</span>
                        <span class="item-type">${item.type || 'Documento'}</span>
                    </div>
                    ${attachmentsHtml}
                `;
                
                return div;
            }
            
            getFileIcon(fileName) {
                const ext = fileName.split('.').pop().toLowerCase();
                const icons = {
                    'pdf': 'üìÑ',
                    'doc': 'üìù',
                    'docx': 'üìù',
                    'txt': 'üìã',
                    'html': 'üåê',
                    'jpg': 'üñºÔ∏è',
                    'jpeg': 'üñºÔ∏è',
                    'png': 'üñºÔ∏è',
                    'gif': 'üñºÔ∏è',
                    'svg': 'üñºÔ∏è'
                };
                return icons[ext] || 'üìé';
            }
            
            setupSearch() {
                this.searchInput.addEventListener('input', (e) => {
                    this.filterItems(e.target.value);
                });
            }
            
            filterItems(query) {
                const items = this.libraryGrid.querySelectorAll('.item');
                const searchTerm = query.toLowerCase();
                
                items.forEach(item => {
                    const title = item.querySelector('.item-title').textContent.toLowerCase();
                    const authors = item.querySelector('.item-authors').textContent.toLowerCase();
                    
                    if (title.includes(searchTerm) || authors.includes(searchTerm)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }
            
            showError(message) {
                this.errorMessage.textContent = message;
                this.errorMessage.style.display = 'block';
                this.loading.style.display = 'none';
            }
        }
        
        // Inicializar la aplicaci√≥n cuando se cargue la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            window.zoteroLibrary = new ZoteroLibrary();
        });
    </script>
</body>
</html>